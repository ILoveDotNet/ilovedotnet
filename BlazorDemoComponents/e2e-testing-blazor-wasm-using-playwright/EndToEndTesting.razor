@page "/blogs/e2e-testing-blazor-wasm-using-playwright"
@using BlazorDemoComponents
@inherits BasePage

<Content FileName=@nameof(EndToEndTesting) UseNewTableOfContentsMenu=true>
    <ContentBody>
        <What>
            <p>
                In this blog post, we will learn how to perform end-to-end testing of a Blazor WebAssembly application
                using Playwright. Playwright is a open sources tool that enables reliable end-to-end testing for modern
                web apps with a single API. It is developed by Microsoft and is a great tool for end-to-end testing of
                web applications.
            </p>
        </What>

        <Why>
            <p>
                End to end testing is essential open to be added to test suite because of the following reasons:
            </p>

            <ol>
                <li><strong>User Workflow Validation:</strong> Simulates real user interactions across the application,
                    ensuring workflows function as expected.</li>
                <li><strong>Integration Assurance:</strong> Verifies seamless communication between different components
                    like APIs, databases, and UIs.</li>
                <li><strong>Regression Prevention:</strong> Detects bugs caused by code changes in interconnected
                    systems.</li>
                <li><strong>Cross-Environment Testing:</strong> Confirms consistent behavior across multiple deployment
                    environments.</li>
                <li><strong>Improved User Experience:</strong> Ensures the application meets user expectations in
                    real-world scenarios.</li>
            </ol>

            <p>
                Playwright integrates with .NET via NUnit or MSTest, offering advanced features like element
                locators, assertions, and codegen for recording tests.
            </p>
        </Why>

        <How>
            <ol>
                <li>
                    <p>
                        The first step is to create e2e test project in a separate solution to avoid conflicts with
                        existing unit and integration tests.
                        Create a new solution and add a new project of type "NUnit Test Project (.NET Core)" using the
                        following cli command.
                    </p>

                    <GithubGistSnippet Title="Create NUnit Playwright project" UserId="fingers10"
                        FileName="a2d23ed2148d6c2d04406932f440bf32"></GithubGistSnippet>

                    <p>
                        This will create sln and csproj as shown below.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/E2E Solution and Project Structure.png"
                            alt="E2E Solution and Project Structure" class="[ w-full ]" />
                    </figure>
                </li>
                <li>
                    Now updated all the nuget packages inside test project.
                </li>
                <li>
                    <p>
                        Default Unit Test includes a <code>PageTest</code> base class with a <code>Page</code> object
                        for browser interaction.
                        I have updated the test to Navigate to I Love .NET's site, assert the title as shown below.
                    </p>

                    <GithubGistSnippet Title="Home page E2E Test" UserId="fingers10"
                        FileName="dfd1e331345bd61bac3bb0079223bd2f"></GithubGistSnippet>
                </li>
                <li>
                    <p>
                        Now run the Project and run the test. I'm running this in mac for first time and noticed the
                        below error.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Playwright First Run Error.png"
                            alt="Playwright First Run Error" class="[ w-full ]" />
                    </figure>
                </li>
                <li>
                    <p>
                        I resolved the above error by installing powershell in mac as shown below
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Install PowerShell in Mac.png"
                            alt="Install PowerShell in Mac" class="[ w-full ]" />
                    </figure>

                    <p>
                        <strong>Note:</strong> You need to do <ContentHighlight>playwright.ps1 install
                        </ContentHighlight> everytime you update the nuget packages in this test project.
                    </p>
                </li>
                <li>
                    <p>
                        Now we need to run <ContentHighlight>/bin/Debug/net9.0/playwright.ps1 install</ContentHighlight>
                        as
                        shown below.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Install Playwright Power Shell Script.png"
                            alt="Install Playwright Power Shell Script" class="[ w-full ]" />
                    </figure>
                </li>
                <li>
                    <p>
                        Now run the test and it should pass as shown below.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/First E2E Test Run.png"
                            alt="First E2E Test Run" class="[ w-full ]" />
                    </figure>
                </li>
            </ol>

            <h4>Recording a test to create it automatically</h4>

            <p>
                Playwright provides a feature to record the test and generate the code for it. This is very useful to
                create the test quickly.
            </p>

            <ol>
                <li>
                    <p>
                        To record the test, run the following command <ContentHighlight>playwright.ps1 codegen
                        </ContentHighlight> as shown below.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Generate code with Playwright using Power Shell Script.png"
                            alt="Generate code with Playwright using Power Shell Script" class="[ w-full ]" />
                    </figure>
                </li>
                <li>
                    <p>
                        This will now open the browser and code generation window. Make sure to select
                        <ContentHighlight>NUnit</ContentHighlight> in the window as shown below.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Playwright Recorder and Code Generator Windows.png"
                            alt="Playwright Recorder and Code Generator Windows" class="[ w-full ]" />
                    </figure>
                </li>
                <li>
                    <p>
                        you can perform the actions you want using the highlighted <ContentHighlight>toolbar
                        </ContentHighlight> in the above browser to record. Once you are done, you can stop the
                        recording and it will generate the code for you as shown below.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Generating Code in Recorder.png"
                            alt="Generating Code in Recorder" class="[ w-full ]" />
                    </figure>
                </li>
                <li>
                    <p>
                        Now you can copy the code and paste it in your test project and run the test.
                        <strong>Note</strong> that sometimes you might need to adjust the code to make it work.
                    </p>

                    <figure>
                        <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Auto Generated Test Passing.png"
                            alt="Auto Generated Test Passing" class="[ w-full ]" />
                    </figure>
                </li>
            </ol>

            <h4>Configuring Base URL from Run Settings</h4>

            <p>
                Hardcoding base URLs in tests limits flexibility, especially when testing across multiple environments
                like QA and staging. To address this, create a BaseTest class that dynamically manages the base URL
                using an environment variable, with an optional fallback or exception if the variable is unset.
                Eliminate hardcoded values by adding a .runsettings file for centralized configuration.a This way we can
                avoid code changes for URL for different environments.
            </p>

            <GithubGistSnippet Title="Run Settings to configure Base URL for Playwright E2E Tests" UserId="fingers10"
                FileName="7d75043bde7c87639bcfebfd9d15aecc"></GithubGistSnippet>

            <p>
                Update test classes to inherit from BaseTest and reference the BaseUrl property for easy maintenance.
                This setup enables seamless testing across different environments without code changes. Debugging is
                simplified with Visual Studio's configuration options, like the auto-detected .runsettings file. This
                approach enhances scalability and efficiency in end-to-end testing workflows.
            </p>

            <GithubGistSnippet Title="Blazor WASM PlayWright E2E Test with Base Test" UserId="fingers10"
                FileName="a159d6d38ade2aa31cbb05633a9dc632"></GithubGistSnippet>

            <p>
                <strong>Note</strong> that you need to run test with <ContentHighlight CssClasses="[ break-all ]">dotnet
                    test EndToEndTests.csproj --settings .runsettings</ContentHighlight> after making above changes.
            </p>

            <h4>Debugging and Screenshots</h4>

            <p>
                Troubleshooting Playwright tests is essential when logic issues or test failures occur. Failed tests
                display
                valuable information in the test output, including expected vs. actual results and locator details.
                Debugging helps pinpoint issues, though locators may not always provide meaningful insights.
            </p>

            <p>
                Enhance troubleshooting by taking screenshots during test execution using await <ContentHighlight
                    CssClasses="[ break-all ]">
                    Page.ScreenshotAsync()</ContentHighlight>. This captures the app's state at specific points, aiding
                in diagnosing issues effectively. This approach
                simplifies debugging and improves test reliability.
            </p>

            <GithubGistSnippet Title="Blazor WASM PlayWright E2E Test with Screenshot" UserId="fingers10"
                FileName="0c0965c9c678d0aa903c1b46e9eb666c"></GithubGistSnippet>

            <p>
                This will generate screenshots of the page while executing that exact line in test and store them in
                bin/debug/net9.0 folder as shown below.
            </p>

            <figure>
                <img src="./image/blogs/blazor/wasm/e2e-testing-blazor-wasm-using-playwright/Screenshot Generated During Test.png"
                    alt="Screenshot Generated During Test" class="[ w-full ]" />
            </figure>
        </How>

        <Summary>

        </Summary>
    </ContentBody>
</Content>