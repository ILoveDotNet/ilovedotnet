@page "/analytics"
@using Toolbelt.Blazor.HeadElement
@inject IConfiguration configuration
@inject Sitemaps sitemap
@inject Achievements achievements

<Title>@Title</Title>
<Meta Property="description" Content="@Description" />
<Meta Property="keywords" Content=".NET, DotNet, I Love DotNet, I ❤️ DotNet, Blazor, Blazor (WebAssembly), Blazor Wasm, C#, Entity Framework, LINQ, ML.NET, Web API, TDD, OOPS, Middleware, JWT, Dependency Injection, Report, Design Pattern, SOLID, HTTPClient" />
<Meta Property="url" Content="@BaseUrl" />
<Meta Property="identifier-URL" Content="@BaseUrl" />
<Meta Property="og:site_name" Content="@Title" />
<Meta Property="og:type" Content="website" />
<Meta Property="og:title" Content="@Title" />
<Meta Property="og:image" Content="@($"{BaseUrl}image/brand/mini-logo.png")" />
<Meta Property="og:image:alt" Content="DotNet bot with heart and DotNet brand" />
<Meta Property="og:description" Content="@Description" />
<Meta Property="og:url" Content="@BaseUrl" />
<Meta Property="twitter:card" Content="summary" />
<Meta Property="twitter:title" Content="@Title" />
<Meta Property="twitter:image" Content="@($"{BaseUrl}image/brand/mini-logo.png")" />
<Meta Property="twitter:image:alt" Content="DotNet bot with heart and DotNet brand" />
<Meta Property="twitter:description" Content="@Description" />
<Meta Property="twitter:url" Content="@BaseUrl" />
@foreach (var sitemap in sitemap.Files)
{
    <Link Rel="sitemap" Href="@($"{BaseUrl}{sitemap}")" type="application/xml" title="Sitemap" />
}
<Link Rel="alternate" Href="@($"{BaseUrl}atom.xml")" type="application/rss+xml" />
<Link Rel="alternate" Href="@BaseUrl" hreflang="en" />
<Link Rel="alternate" Href="@BaseUrl" hreflang="x-default" />
<Link Rel="canonical" Href="@BaseUrl" />
<Link Rel="index" Href="@BaseUrl" title="@Title" />
<HeadContent>
    @(new MarkupString(
    $$""""
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebSite",
            "publisher": {
                "@type": "Organization",
                "name": "{{Title}}",
                "url": "{{BaseUrl}}",
                "logo": {
                    "@type": "ImageObject",
                    "url": "{{BaseUrl}}favicon.ico",
                    "width": 16,
                    "height": 16
                }
            },
            "url": "{{BaseUrl}}",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "{{BaseUrl}}"
            },
            "description": "{{Description}}"
        }
        </script>
        """"
        ))

    <style type="text/css">
        #google-search-impact-chart {
            display: grid;
            align-items: center;
            justify-items: center;
            grid-template-columns: 20px 1fr;
            grid-template-rows: 400px 60px;
            grid-template-areas:
                "data-axis chart"
                ".         primary-axis";
        }
        #google-search-impact-chart > table {
            grid-area: chart;
        }
        #google-search-impact-chart > .primary-axis {
            grid-area: primary-axis;
        }
        #google-search-impact-chart > .data-axis {
            grid-area: data-axis;
            writing-mode: tb-rl;
            transform: rotateZ(180deg);
        }
    </style>
</HeadContent>

<section class="[ dark:bg-stone-900 ] [ flex flex-col ] [ space-y-5 ] [ p-5 ]">

    <StarAndShareRequest></StarAndShareRequest>

    <h2 class="[ dark:text-white ] [ font-semibold text-xl ]">Analytics</h2>

    <p>
        This page is for analytics purpose only. Here you can see the progress we are making in terms of page views and visitors. This is because of the support from community. 
        Thank you for your support.
    </p>

    <h3 class="[ dark:text-white ] [ font-semibold text-lg ]">Google Search Impact</h3>

    <div id="google-search-impact-chart" class="[ w-full ]">
        <table class="[ charts-css column show-heading show-labels show-data-axes show-primary-axis data-spacing-5 ]" style="height: 400px">
            <caption> Google Search Impact </caption>
            <thead>
                <tr>
                    <th scope="col"> Achieved On </th>
                    <th scope="col"> Clicks </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var googleSearchImpact in GroupedAchievements)
                {
                    var date = new DateTime(googleSearchImpact.Key.Year, googleSearchImpact.Key.Month, 1);
                    var clicks = googleSearchImpact.Sum(x => x.Clicks);
                    <tr>
                        <th scope="row" class="[ pt-16 md:pt-8 ]"> @($"{date:MMM yy}") </th>
                        <td style="--size: calc( @clicks / @CurrentAchievement )" class="[ bg-gradient-to-b from-indigo-500 via-purple-500 to-pink-500 ]"> 
                            <span class="data" style="margin-top: -20px;"> @clicks </span> 
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="primary-axis"> Achieved On </div>

        <div class="data-axis"> Clicks </div>
    </div>

</section>

@code {
    private string Title = "Analytics - I ❤️ DotNet";
    private string Description = "This is a .NET knowledge sharing platform with live demos crafted by developers for developers with love.";
    private string BaseUrl => configuration.GetValue<string>("baseUrl")!;
    private IEnumerable<IGrouping<DateOnly, GoogleSearchImpact>> GroupedAchievements => achievements.GoogleSearchImpacts.GroupBy(x => DateOnly.FromDateTime(new DateTime(x.Date.Year, x.Date.Month, 1)));
    private long CurrentAchievement => GroupedAchievements.Max(x => x.Sum(x => x.Clicks));
}
